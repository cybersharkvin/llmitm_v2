# Code Architecture Overview

## Plugin Architecture

### Abstract Base Classes
- **StepHandler** (`llmitm_v2/handlers/base.py:9`)

### Concrete Implementations
- **ActionGraph** extends `BaseModel` (`llmitm_v2/models/action_graph.py:11`)
- **ApprovalHook** extends `HookProvider` (`llmitm_v2/hooks/approval_hook.py:18`)
- **AttackOpportunity** extends `BaseModel` (`llmitm_v2/models/recon.py:22`)
- **CompilationContext** extends `BaseModel` (`llmitm_v2/models/context.py:53`)
- **CriticFeedback** extends `BaseModel` (`llmitm_v2/models/critic.py:10`)
- **DiscoveredEndpoint** extends `BaseModel` (`llmitm_v2/models/recon.py:10`)
- **ExecutionContext** extends `BaseModel` (`llmitm_v2/models/context.py:11`)
- **ExecutionResult** extends `BaseModel` (`llmitm_v2/models/context.py:87`)
- **FailureType** extends `str, Enum` (`llmitm_v2/constants.py:26`)
- **Finding** extends `BaseModel` (`llmitm_v2/models/finding.py:9`)
- **Fingerprint** extends `BaseModel` (`llmitm_v2/models/fingerprint.py:9`)
- **HTTPRequestHandler** extends `StepHandler` (`llmitm_v2/handlers/http_request_handler.py:13`)
- **OrchestratorResult** extends `BaseModel` (`llmitm_v2/models/context.py:97`)
- **ReconCriticFeedback** extends `BaseModel` (`llmitm_v2/models/recon.py:62`)
- **ReconReport** extends `BaseModel` (`llmitm_v2/models/recon.py:33`)
- **RegexMatchHandler** extends `StepHandler` (`llmitm_v2/handlers/regex_match_handler.py:10`)
- **RepairContext** extends `BaseModel` (`llmitm_v2/models/context.py:68`)
- **RepairDiagnosis** extends `BaseModel` (`llmitm_v2/models/critic.py:21`)
- **Settings** extends `BaseSettings` (`llmitm_v2/config.py:6`)
- **ShellCommandHandler** extends `StepHandler` (`llmitm_v2/handlers/shell_command_handler.py:12`)
- **Step** extends `BaseModel` (`llmitm_v2/models/step.py:10`)
- **StepPhase** extends `str, Enum` (`llmitm_v2/constants.py:6`)
- **StepResult** extends `BaseModel` (`llmitm_v2/models/context.py:32`)
- **StepType** extends `str, Enum` (`llmitm_v2/constants.py:16`)

### Factory Functions
- **create_actor_agent**( graph_repo: GraphRepository, embed_model: Optional[Any] = None, model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:67`)
- **create_critic_agent**( model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:108`)
- **create_recon_agent**( proxy_url: str, model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:195`)
- **create_recon_critic_agent**( model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:224`)

## All Classes
- **ActionGraph** (`llmitm_v2/models/action_graph.py:11`)
- **ApprovalHook** (`llmitm_v2/hooks/approval_hook.py:18`)
- **AttackOpportunity** (`llmitm_v2/models/recon.py:22`)
- **CompilationContext** (`llmitm_v2/models/context.py:53`)
- **CriticFeedback** (`llmitm_v2/models/critic.py:10`)
- **DiscoveredEndpoint** (`llmitm_v2/models/recon.py:10`)
- **ExecutionContext** (`llmitm_v2/models/context.py:11`)
- **ExecutionResult** (`llmitm_v2/models/context.py:87`)
- **FailureType** (`llmitm_v2/constants.py:26`)
- **Finding** (`llmitm_v2/models/finding.py:9`)
- **Fingerprint** (`llmitm_v2/models/fingerprint.py:9`)
- **Fingerprinter** (`llmitm_v2/fingerprinter.py:9`)
- **GraphRepository** (`llmitm_v2/repository/graph_repository.py:16`)
- **GraphTools** (`llmitm_v2/tools/graph_tools.py:20`)
- **HTTPRequestHandler** (`llmitm_v2/handlers/http_request_handler.py:13`)
- **LLMitMCaptureAddon** (`llmitm_v2/capture/addon.py:12`)
- **Orchestrator** (`llmitm_v2/orchestrator/orchestrator.py:44`)
- **OrchestratorResult** (`llmitm_v2/models/context.py:97`)
- **ReconCriticFeedback** (`llmitm_v2/models/recon.py:62`)
- **ReconReport** (`llmitm_v2/models/recon.py:33`)
- **ReconTools** (`llmitm_v2/tools/recon_tools.py:18`)
- **RegexMatchHandler** (`llmitm_v2/handlers/regex_match_handler.py:10`)
- **RepairContext** (`llmitm_v2/models/context.py:68`)
- **RepairDiagnosis** (`llmitm_v2/models/critic.py:21`)
- **Settings** (`llmitm_v2/config.py:6`)
- **ShellCommandHandler** (`llmitm_v2/handlers/shell_command_handler.py:12`)
- **Step** (`llmitm_v2/models/step.py:10`)
- **StepHandler** (`llmitm_v2/handlers/base.py:9`)
- **StepPhase** (`llmitm_v2/constants.py:6`)
- **StepResult** (`llmitm_v2/models/context.py:32`)
- **StepType** (`llmitm_v2/constants.py:16`)

## All Functions
- **_format_traffic_log**(flows: list[dict]) (`llmitm_v2/capture/launcher.py:39`)
- **_print**(msg: str) (`llmitm_v2/repository/setup_schema.py:23`)
- **_wait_for_port**(port: int, host: str = "127.0.0.1", timeout: float = 10.0) (`llmitm_v2/capture/launcher.py:27`)
- **assemble_compilation_context**(fingerprint: Fingerprint, traffic_log: str) (`llmitm_v2/orchestrator/context.py:11`)
- **assemble_compilation_context_from_recon**(recon_report: ReconReport) (`llmitm_v2/orchestrator/context.py:147`)
- **assemble_recon_context**(target_url: str) (`llmitm_v2/orchestrator/context.py:109`)
- **assemble_repair_context**( failed_step: Step, error_log: str, execution_history: list[str] ) (`llmitm_v2/orchestrator/context.py:56`)
- **classify_failure**(error_log: str, status_code: int = 0) (`llmitm_v2/orchestrator/failure_classifier.py:6`)
- **create_actor_agent**( graph_repo: GraphRepository, embed_model: Optional[Any] = None, model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:67`)
- **create_critic_agent**( model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:108`)
- **create_recon_agent**( proxy_url: str, model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:195`)
- **create_recon_critic_agent**( model_id: str = "claude-haiku-4-5-20251001", api_key: Optional[str] = None, ) (`llmitm_v2/orchestrator/agents.py:224`)
- **get_handler**(step_type: StepType) (`llmitm_v2/handlers/registry.py:18`)
- **interpolate_value**(value: any) (`llmitm_v2/orchestrator/orchestrator.py:241`)
- **main**() (`llmitm_v2/__main__.py:25`)
- **quick_fingerprint**(target_url: str) (`llmitm_v2/capture/launcher.py:69`)
- **replacer**(match: re.Match) (`llmitm_v2/orchestrator/orchestrator.py:234`)
- **run_recon**(settings: Settings) (`llmitm_v2/capture/launcher.py:109`)
- **setup_schema**(quiet: bool = False) (`llmitm_v2/repository/setup_schema.py:12`)
- **tool**(func) (`llmitm_v2/tools/graph_tools.py:13`)
- **tool**(func) (`llmitm_v2/tools/recon_tools.py:13`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:471`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:94`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:138`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:277`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:321`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:35`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:437`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:224`)
- **tx_func**(tx: Session) (`llmitm_v2/repository/graph_repository.py:68`)

## All Methods
- **__init__**(self) (`llmitm_v2/capture/addon.py:15`)
- **__init__**(self, destructive_patterns: list[str] | None = None) (`llmitm_v2/hooks/approval_hook.py:25`)
- **__init__**(self, graph_repo: GraphRepository, settings: Settings) (`llmitm_v2/orchestrator/orchestrator.py:47`)
- **__init__**(self, driver: Driver) (`llmitm_v2/repository/graph_repository.py:19`)
- **__init__**(self, repo: GraphRepository, embed_model: Optional[Any] = None) (`llmitm_v2/tools/graph_tools.py:23`)
- **__init__**(self, proxy_url: str) (`llmitm_v2/tools/recon_tools.py:21`)
- **_compile**( self, fingerprint: Fingerprint, traffic_log: str, recon_report: Optional[ReconReport] = None, ) (`llmitm_v2/orchestrator/orchestrator.py:85`)
- **_execute**( self, action_graph: ActionGraph, fingerprint: Fingerprint ) (`llmitm_v2/orchestrator/orchestrator.py:127`)
- **_extract_auth_model**(requests: list[dict[str, Any]]) (`llmitm_v2/fingerprinter.py:123`)
- **_extract_endpoint_pattern**(requests: list[dict[str, Any]]) (`llmitm_v2/fingerprinter.py:142`)
- **_extract_security_signals**(responses: list[dict[str, Any]]) (`llmitm_v2/fingerprinter.py:160`)
- **_extract_tech_stack**(responses: list[dict[str, Any]]) (`llmitm_v2/fingerprinter.py:112`)
- **_handle_step_failure**( self, step: Step, result: StepResult, context: ExecutionContext, action_graph: ActionGraph, retried: bool, ) (`llmitm_v2/orchestrator/orchestrator.py:190`)
- **_interpolate_params**(step: Step, context: ExecutionContext) (`llmitm_v2/orchestrator/orchestrator.py:232`)
- **_parse_request**(text: str) (`llmitm_v2/fingerprinter.py:50`)
- **_parse_response**(text: str) (`llmitm_v2/fingerprinter.py:82`)
- **_parse_traffic_log**(traffic_log: str) (`llmitm_v2/fingerprinter.py:29`)
- **_repair**( self, action_graph: ActionGraph, failed_step: Step, error_log: str, execution_history: list[str], fingerprint_hash: Optional[str], ) (`llmitm_v2/orchestrator/orchestrator.py:254`)
- **_try_warm_start**(self, fingerprint: Fingerprint) (`llmitm_v2/orchestrator/orchestrator.py:78`)
- **_write_flows_to_file**(self) (`llmitm_v2/capture/addon.py:33`)
- **check_approval**(self, event: Any) (`llmitm_v2/hooks/approval_hook.py:55`)
- **compute_hash**(self) (`llmitm_v2/models/fingerprint.py:32`)
- **done**(self) (`llmitm_v2/capture/addon.py:44`)
- **embed_model**(self) (`llmitm_v2/tools/graph_tools.py:34`)
- **ensure_hash**(self) (`llmitm_v2/models/fingerprint.py:41`)
- **ensure_id**(self) (`llmitm_v2/models/action_graph.py:36`)
- **ensure_id**(self) (`llmitm_v2/models/finding.py:32`)
- **execute**(self, step: Step, context: ExecutionContext) (`llmitm_v2/handlers/base.py:13`)
- **execute**(self, step: Step, context: ExecutionContext) (`llmitm_v2/handlers/http_request_handler.py:16`)
- **execute**(self, step: Step, context: ExecutionContext) (`llmitm_v2/handlers/regex_match_handler.py:13`)
- **execute**(self, step: Step, context: ExecutionContext) (`llmitm_v2/handlers/shell_command_handler.py:15`)
- **find_similar_action_graphs**(self, description: str, top_k: int = 5) (`llmitm_v2/tools/graph_tools.py:43`)
- **find_similar_fingerprints**( self, embedding: List[float], top_k: int = 5, ) (`llmitm_v2/repository/graph_repository.py:79`)
- **fingerprint**(self, traffic_log: str) (`llmitm_v2/fingerprinter.py:12`)
- **get_action_graph_with_steps**( self, fingerprint_hash: str, ) (`llmitm_v2/repository/graph_repository.py:209`)
- **get_fingerprint_by_hash**(self, hash_value: str) (`llmitm_v2/repository/graph_repository.py:58`)
- **get_repair_history**( self, fingerprint_hash: str, max_results: int = 10, ) (`llmitm_v2/repository/graph_repository.py:453`)
- **get_repair_history**( self, fingerprint_hash: str, max_results: int = 10, ) (`llmitm_v2/tools/graph_tools.py:117`)
- **http_request**(self, method: str, path: str, headers: dict = None, body: str = "") (`llmitm_v2/tools/recon_tools.py:27`)
- **increment_execution_count**( self, action_graph_id: str, succeeded: bool, ) (`llmitm_v2/repository/graph_repository.py:425`)
- **register_hooks**(self, registry: Any, **kwargs: Any) (`llmitm_v2/hooks/approval_hook.py:46`)
- **repair_step_chain**( self, action_graph_id: str, failed_step_order: int, new_steps: List[Step], ) (`llmitm_v2/repository/graph_repository.py:304`)
- **response**(self, flow: http.HTTPFlow) (`llmitm_v2/capture/addon.py:18`)
- **run**( self, fingerprint: Fingerprint, traffic_log: str, recon_report: Optional[ReconReport] = None, ) (`llmitm_v2/orchestrator/orchestrator.py:51`)
- **save_action_graph**( self, fingerprint_hash: str, action_graph: ActionGraph, ) (`llmitm_v2/repository/graph_repository.py:116`)
- **save_finding**( self, action_graph_id: str, finding: Finding, ) (`llmitm_v2/repository/graph_repository.py:264`)
- **save_fingerprint**(self, fingerprint: Fingerprint) (`llmitm_v2/repository/graph_repository.py:27`)
- **shell_command**(self, command: str) (`llmitm_v2/tools/recon_tools.py:44`)
- **success_rate**(self) (`llmitm_v2/models/action_graph.py:41`)
- **to_fingerprint**(self) (`llmitm_v2/models/recon.py:50`)
